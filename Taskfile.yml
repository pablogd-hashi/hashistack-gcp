version: '3'

vars:
  DC1_DIR: clusters/dc1/terraform
  DC2_DIR: clusters/dc2/terraform
  GKE_WEST_DIR: clusters/gke-europe-west1/terraform
  GKE_SW_DIR: clusters/gke-southwest/terraform

tasks:
  # === Image Building (First Step) ===

  build-images:
    desc: "Build HashiStack images with Packer (REQUIRED FIRST STEP)"
    dir: "packer/gcp"
    cmds:
      - echo "ğŸ”¨ Building HashiStack images for new project..."
      - packer build .
      - echo "âœ… HashiStack images built successfully"

  # === Core Infrastructure Deployment ===
  
  deploy-dc1:
    desc: "Deploy DC1 cluster (europe-southwest1)"
    dir: "{{.DC1_DIR}}"
    cmds:
      - echo "ğŸš€ Deploying DC1 cluster..."
      - terraform init
      - terraform apply -auto-approve
      - echo "âœ… DC1 cluster deployed successfully"
      - task: show-dc1-info

  deploy-dc2:
    desc: "Deploy DC2 cluster (europe-west1)"
    dir: "{{.DC2_DIR}}"
    cmds:
      - echo "ğŸš€ Deploying DC2 cluster..."
      - terraform init
      - terraform apply -auto-approve
      - echo "âœ… DC2 cluster deployed successfully"
      - task: show-dc2-info

  deploy-gke-west:
    desc: "Deploy GKE cluster (europe-west1)"
    dir: "{{.GKE_WEST_DIR}}"
    cmds:
      - echo "ğŸš€ Deploying GKE Europe West1 cluster..."
      - terraform init
      - terraform apply -auto-approve
      - echo "âœ… GKE Europe West1 cluster deployed successfully"

  deploy-gke-southwest:
    desc: "Deploy GKE cluster (europe-southwest1)"
    dir: "{{.GKE_SW_DIR}}"
    cmds:
      - echo "ğŸš€ Deploying GKE Southwest cluster..."
      - terraform init
      - terraform apply -auto-approve
      - echo "âœ… GKE Southwest cluster deployed successfully"

  # === Combined Deployments ===

  deploy-both-dc:
    desc: "Deploy both DC1 and DC2 clusters"
    cmds:
      - task: deploy-dc1
      - task: deploy-dc2
      - echo "ğŸ‰ Both DC clusters deployed successfully"
      - task: show-all-urls

  deploy-both-gke:
    desc: "Deploy both GKE clusters"
    cmds:
      - task: deploy-gke-west
      - task: deploy-gke-southwest
      - echo "ğŸ‰ Both GKE clusters deployed successfully"

  deploy-all:
    desc: "Deploy all clusters (DC1, DC2, GKE West, GKE Southwest)"
    cmds:
      - task: deploy-both-dc
      - task: deploy-both-gke
      - echo "ğŸ‰ All clusters deployed successfully"

  # === Post-Deployment Configuration ===

  setup-consul-nomad-dc1:
    desc: "Configure Nomad-Consul integration on DC1 (REQUIRED after DC deployment)"
    cmds:
      - echo "âš™ï¸  Configuring Nomad-Consul integration on DC1..."
      - echo "Run this command on DC1 server - nomad setup consul -y"
      - echo "Use - task ssh-dc1-server"

  setup-consul-nomad-dc2:
    desc: "Configure Nomad-Consul integration on DC2 (REQUIRED after DC deployment)"
    cmds:
      - echo "âš™ï¸  Configuring Nomad-Consul integration on DC2..."
      - echo "Run this command on DC2 server - nomad setup consul -y"
      - echo "Use - task ssh-dc2-server"

  setup-consul-nomad-both:
    desc: "Configure Nomad-Consul integration on both DC clusters"
    cmds:
      - task: setup-consul-nomad-dc1
      - task: setup-consul-nomad-dc2

  # === Application Deployment ===

  deploy-traefik-dc1:
    desc: "Deploy Traefik load balancer on DC1"
    cmds:
      - echo "ğŸ”€ Deploying Traefik on DC1..."
      - cd {{.DC1_DIR}} && terraform output -raw ssh_dc1_server | bash -c 'ssh -o StrictHostKeyChecking=no ubuntu@$(cat) "export NOMAD_ADDR=http://localhost:4646 && export NOMAD_TOKEN=$(terraform output -raw nomad_token) && nomad job run /opt/nomad-apps/monitoring/traefik.hcl"'

  deploy-traefik-dc2:
    desc: "Deploy Traefik load balancer on DC2"
    cmds:
      - echo "ğŸ”€ Deploying Traefik on DC2..."
      - cd {{.DC2_DIR}} && terraform output -raw ssh_dc2_server | bash -c 'ssh -o StrictHostKeyChecking=no ubuntu@$(cat) "export NOMAD_ADDR=http://localhost:4646 && export NOMAD_TOKEN=$(terraform output -raw nomad_token) && nomad job run /opt/nomad-apps/monitoring/traefik.hcl"'

  deploy-monitoring-dc1:
    desc: "Deploy monitoring stack (Prometheus + Grafana) on DC1"
    cmds:
      - echo "ğŸ“Š Deploying monitoring stack on DC1..."
      - task: deploy-traefik-dc1
      - echo "Deploying Prometheus and Grafana..."
      # Add actual deployment commands here

  deploy-monitoring-dc2:
    desc: "Deploy monitoring stack (Prometheus + Grafana) on DC2"
    cmds:
      - echo "ğŸ“Š Deploying monitoring stack on DC2..."
      - task: deploy-traefik-dc2
      - echo "Deploying Prometheus and Grafana..."
      # Add actual deployment commands here

  # === Information and Status ===

  show-dc1-info:
    desc: "Show DC1 cluster information"
    dir: "{{.DC1_DIR}}"
    cmds:
      - echo "=== DC1 Cluster Info ==="
      - terraform output cluster_info 2>/dev/null || echo "âŒ DC1 not deployed"
      - echo "=== DC1 URLs ==="
      - terraform output hashistack_urls 2>/dev/null || echo "âŒ DC1 URLs not available"

  show-dc2-info:
    desc: "Show DC2 cluster information"
    dir: "{{.DC2_DIR}}"
    cmds:
      - echo "=== DC2 Cluster Info ==="
      - terraform output cluster_info 2>/dev/null || echo "âŒ DC2 not deployed"
      - echo "=== DC2 URLs ==="
      - terraform output hashistack_urls 2>/dev/null || echo "âŒ DC2 URLs not available"

  show-all-urls:
    desc: "Show all cluster URLs and access information"
    cmds:
      - echo "ğŸŒ === ALL CLUSTER ACCESS INFORMATION ==="
      - task: show-dc1-info
      - task: show-dc2-info
      - echo ""
      - echo "ğŸ“‹ Next steps -"
      - echo "1. Configure Nomad-Consul integration - task setup-consul-nomad-both"
      - echo "2. For cluster peering - task -t tasks/peering.yml help"
      - echo "3. For admin partitions - task -t tasks/admin-partitions.yml help"
      - echo "4. For boundary integration - task -t tasks/boundary.yml help"

  get-all-ips:
    desc: "Get all server and client IPs from all clusters"
    cmds:
      - echo "ğŸ–¥ï¸  === ALL CLUSTER IPS ==="
      - echo "=== DC1 IPs ==="
      - cd {{.DC1_DIR}} && terraform output server_ips 2>/dev/null || echo "âŒ DC1 not deployed"
      - cd {{.DC1_DIR}} && terraform output client_ips 2>/dev/null || echo "âŒ DC1 not deployed"
      - echo ""
      - echo "=== DC2 IPs ==="
      - cd {{.DC2_DIR}} && terraform output server_ips 2>/dev/null || echo "âŒ DC2 not deployed"
      - cd {{.DC2_DIR}} && terraform output client_ips 2>/dev/null || echo "âŒ DC2 not deployed"

  # === SSH Access ===

  ssh-dc1-server:
    desc: "SSH to DC1 server node"
    dir: "{{.DC1_DIR}}"
    cmds:
      - terraform output -raw ssh_dc1_server | bash

  ssh-dc2-server:
    desc: "SSH to DC2 server node"  
    dir: "{{.DC2_DIR}}"
    cmds:
      - terraform output -raw ssh_dc2_server | bash

  # === Cleanup ===

  destroy-dc1:
    desc: "Destroy DC1 cluster"
    dir: "{{.DC1_DIR}}"
    cmds:
      - echo "ğŸ—‘ï¸  Destroying DC1 cluster..."
      - terraform destroy -auto-approve

  destroy-dc2:
    desc: "Destroy DC2 cluster"
    dir: "{{.DC2_DIR}}"
    cmds:
      - echo "ğŸ—‘ï¸  Destroying DC2 cluster..."
      - terraform destroy -auto-approve

  destroy-gke-west:
    desc: "Destroy GKE Europe West1 cluster"
    dir: "{{.GKE_WEST_DIR}}"
    cmds:
      - echo "ğŸ—‘ï¸  Destroying GKE Europe West1 cluster..."
      - terraform destroy -auto-approve

  destroy-gke-southwest:
    desc: "Destroy GKE Southwest cluster"
    dir: "{{.GKE_SW_DIR}}"
    cmds:
      - echo "ğŸ—‘ï¸  Destroying GKE Southwest cluster..."
      - terraform destroy -auto-approve

  destroy-both-dc:
    desc: "Destroy both DC clusters"
    cmds:
      - task: destroy-dc1
      - task: destroy-dc2

  destroy-both-gke:
    desc: "Destroy both GKE clusters"
    cmds:
      - task: destroy-gke-west
      - task: destroy-gke-southwest

  destroy-all:
    desc: "Destroy all clusters"
    cmds:
      - task: destroy-both-dc
      - task: destroy-both-gke
      - echo "ğŸ—‘ï¸  All clusters destroyed"

  # === Help and Status ===

  status:
    desc: "Show status of all clusters"
    cmds:
      - echo "ğŸ“Š === CLUSTER STATUS ==="
      - task: show-all-urls
      - task: get-all-ips
      - echo ""
      - echo "ğŸ“‹ Available feature modules -"
      - echo "- Cluster Peering - task -t tasks/peering.yml help"
      - echo "- Admin Partitions - task -t tasks/admin-partitions.yml help"  
      - echo "- Boundary Integration - task -t tasks/boundary.yml help"
      - echo "- CTS Integration - task -t tasks/cts.yml help"

  help:
    desc: "Show available tasks and getting started guide"
    cmds:
      - echo "ğŸš€ === HASHISTACK GCP DEPLOYMENT ==="
      - echo ""
      - echo "ğŸ“‹ CORE INFRASTRUCTURE TASKS -"
      - echo "  build-images           - Build HashiStack images (REQUIRED FIRST)"
      - echo "  deploy-dc1            - Deploy DC1 cluster (europe-southwest1)"
      - echo "  deploy-dc2            - Deploy DC2 cluster (europe-west1)"
      - echo "  deploy-gke-west       - Deploy GKE Europe West1 cluster"
      - echo "  deploy-gke-southwest  - Deploy GKE Southwest cluster"
      - echo "  deploy-both-dc        - Deploy both DC clusters"
      - echo "  deploy-both-gke       - Deploy both GKE clusters"
      - echo "  deploy-all            - Deploy all clusters"
      - echo ""
      - echo "ğŸ”§ POST-DEPLOYMENT -"
      - echo "  setup-consul-nomad-both - Configure Nomad-Consul integration (REQUIRED)"
      - echo "  deploy-monitoring-dc1   - Deploy monitoring stack on DC1"
      - echo "  deploy-monitoring-dc2   - Deploy monitoring stack on DC2"
      - echo ""
      - echo "ğŸ“Š INFORMATION -"
      - echo "  show-all-urls         - Show all cluster URLs and access info"
      - echo "  get-all-ips          - Get all server and client IPs"
      - echo "  status               - Show complete cluster status"
      - echo ""
      - echo "ğŸ”Œ SSH ACCESS -"
      - echo "  ssh-dc1-server       - SSH to DC1 server"
      - echo "  ssh-dc2-server       - SSH to DC2 server"
      - echo ""
      - echo "ğŸ—‘ï¸  CLEANUP -"
      - echo "  destroy-dc1          - Destroy DC1 cluster"
      - echo "  destroy-dc2          - Destroy DC2 cluster"
      - echo "  destroy-both-dc      - Destroy both DC clusters"
      - echo "  destroy-all          - Destroy all clusters"
      - echo ""
      - echo "ğŸ”§ FEATURE MODULES -"
      - echo "  task -t tasks/peering.yml help           - Cluster peering setup"
      - echo "  task -t tasks/admin-partitions.yml help  - Admin partitions setup"
      - echo "  task -t tasks/boundary.yml help          - Boundary integration"
      - echo "  task -t tasks/cts.yml help               - Consul Terraform Sync"
      - echo ""
      - echo "ğŸ“– QUICK START -"
      - echo "  1. task build-images"
      - echo "  2. task deploy-both-dc"
      - echo "  3. task setup-consul-nomad-both"
      - echo "  4. task show-all-urls"

  default:
    desc: "Show help by default"
    cmds:
      - task: help