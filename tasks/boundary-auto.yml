version: '3'

vars:
  BOUNDARY_DIR: ../boundary/terraform
  DC1_DIR: ../clusters/dc1/terraform
  DC2_DIR: ../clusters/dc2/terraform

tasks:
  help:
    desc: "Show automated Boundary deployment and management guide"
    cmds:
      - echo "ü§ñ === AUTOMATED BOUNDARY DEPLOYMENT ==="
      - echo ""
      - echo "Fully automated Boundary setup with target discovery and credential injection"
      - echo ""
      - echo "üìã PREREQUISITES -"
      - echo "  ‚úÖ DC1 and/or DC2 clusters deployed"
      - echo "  ‚úÖ Environment variables configured - task eval-both"
      - echo "  ‚úÖ HCP Boundary cluster running"
      - echo "  ‚úÖ SSH public key configured in Terraform workspace variables"
      - echo ""
      - echo "üìñ DOCUMENTATION - boundary/README.md"
      - echo ""
      - echo "üöÄ AUTOMATED DEPLOYMENT -"
      - echo "  setup-full        - Complete automated setup (recommended)"
      - echo "  discover-targets  - Auto-discover infrastructure targets"
      - echo "  inject-credentials - Auto-inject SSH credentials"
      - echo "  deploy-complete   - Deploy with full automation"
      - echo ""
      - echo "üîß MANAGEMENT -"
      - echo "  list-all-targets  - List all discovered targets"
      - echo "  test-all-connections - Test SSH to all targets"
      - echo "  update-discovery  - Refresh target discovery"
      - echo "  status-full       - Complete deployment status"
      - echo ""
      - echo "üîó CONNECTION HELPERS -"
      - echo "  connect-dc1-server  - Quick connect to DC1 server"
      - echo "  connect-dc2-server  - Quick connect to DC2 server"
      - echo "  connect-dc1-client  - Quick connect to DC1 client"
      - echo "  connect-dc2-client  - Quick connect to DC2 client"
      - echo ""
      - echo "üóëÔ∏è  CLEANUP -"
      - echo "  cleanup-all       - Remove all Boundary resources"
      - echo ""
      - echo "üìñ QUICK START -"
      - echo "  task -t tasks/boundary-auto.yml setup-full"

  discover-targets:
    desc: "Auto-discover all infrastructure targets"
    cmds:
      - echo "üîç Discovering infrastructure targets..."
      - echo ""
      - echo "=== DC1 Servers ==="
      - cd {{.DC1_DIR}} && terraform output -json server_nodes 2>/dev/null || echo "‚ùå DC1 not deployed"
      - echo ""
      - echo "=== DC1 Clients ==="
      - cd {{.DC1_DIR}} && terraform output -json client_nodes 2>/dev/null || echo "‚ùå DC1 clients not available"
      - echo ""
      - echo "=== DC2 Servers ==="
      - cd {{.DC2_DIR}} && terraform output -json server_nodes 2>/dev/null || echo "‚ùå DC2 not deployed"
      - echo ""
      - echo "=== DC2 Clients ==="
      - cd {{.DC2_DIR}} && terraform output -json client_nodes 2>/dev/null || echo "‚ùå DC2 clients not available"
      - echo ""
      - echo "‚ÑπÔ∏è  Target discovery completed. Use deploy-complete to create Boundary targets."

  inject-credentials:
    desc: "Auto-inject SSH credentials for all targets"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîë Auto-injecting SSH credentials..."
      - echo ""
      - echo "Credential injection will be handled by Terraform using workspace variables -"
      - echo "- ssh_public_key (from Terraform workspace)"
      - echo "- ssh_private_key (from Terraform workspace)"
      - echo "- ssh_username (default - ubuntu)"
      - echo ""
      - echo "‚úÖ Credentials configured for automatic injection"

  deploy-complete:
    desc: "Deploy Boundary with full automation"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üöÄ Deploying Boundary with full automation..."
      - echo ""
      - echo "This will -"
      - echo "1. Auto-discover all infrastructure targets (servers + clients)"
      - echo "2. Create Boundary host catalogs for DC1 and DC2"
      - echo "3. Create host sets for servers and clients"
      - echo "4. Create targets with SSH credential injection"
      - echo "5. Configure credential stores with SSH keys"
      - echo ""
      - terraform init
      - terraform plan
      - echo ""
      - echo "Applying Boundary configuration..."
      - terraform apply -auto-approve
      - echo ""
      - echo "‚úÖ Boundary deployment completed with full automation"
      - task: status-full

  setup-full:
    desc: "Complete automated Boundary setup (recommended)"
    cmds:
      - echo "ü§ñ Starting complete automated Boundary setup..."
      - echo ""
      - task: discover-targets
      - task: inject-credentials
      - task: deploy-complete
      - echo ""
      - echo "üéâ Automated Boundary setup completed!"
      - echo ""
      - echo "Next steps -"
      - echo "1. Authenticate - boundary authenticate password -auth-method-id <auth-method>"
      - echo "2. List targets - task -t tasks/boundary-auto.yml list-all-targets"
      - echo "3. Test connections - task -t tasks/boundary-auto.yml test-all-connections"

  list-all-targets:
    desc: "List all discovered and configured targets"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üéØ All Boundary Targets -"
      - echo ""
      - echo "=== DC1 Targets ==="
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc1")) | "\\(.key) - \\(.value.id) (\\(.value.type) port \\(.value.port))"' 2>/dev/null || echo "‚ùå No DC1 targets configured"
      - echo ""
      - echo "=== DC2 Targets ==="
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc2")) | "\\(.key) - \\(.value.id) (\\(.value.type) port \\(.value.port))"' 2>/dev/null || echo "‚ùå No DC2 targets configured"
      - echo ""
      - echo "=== Connection Commands ==="
      - terraform output connection_commands 2>/dev/null || echo "‚ùå Connection commands not available"

  test-all-connections:
    desc: "Test SSH connections to all targets"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üß™ Testing all Boundary SSH connections..."
      - echo ""
      - echo "Available targets for testing -"
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | "Target - \\(.key)\\nID - \\(.value.id)\\nCommand - boundary connect ssh -target-id \\(.value.id)\\n"' || echo "‚ùå No targets available for testing"
      - echo ""
      - echo "To test a specific target -"
      - echo "boundary connect ssh -target-id <target-id-from-above>"
      - echo ""
      - echo "To test all targets automatically, run each command above."

  connect-dc1-server:
    desc: "Quick connect to DC1 server via Boundary"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîó Connecting to DC1 server via Boundary..."
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc1") and contains("server")) | "boundary connect ssh -target-id \\(.value.id)"' | head -1 || echo "‚ùå No DC1 server targets available"

  connect-dc2-server:
    desc: "Quick connect to DC2 server via Boundary"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîó Connecting to DC2 server via Boundary..."
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc2") and contains("server")) | "boundary connect ssh -target-id \\(.value.id)"' | head -1 || echo "‚ùå No DC2 server targets available"

  connect-dc1-client:
    desc: "Quick connect to DC1 client via Boundary"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîó Connecting to DC1 client via Boundary..."
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc1") and contains("client")) | "boundary connect ssh -target-id \\(.value.id)"' | head -1 || echo "‚ùå No DC1 client targets available"

  connect-dc2-client:
    desc: "Quick connect to DC2 client via Boundary"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîó Connecting to DC2 client via Boundary..."
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | select(.key | contains("dc2") and contains("client")) | "boundary connect ssh -target-id \\(.value.id)"' | head -1 || echo "‚ùå No DC2 client targets available"

  update-discovery:
    desc: "Refresh target discovery and update Boundary"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üîÑ Refreshing target discovery..."
      - task: discover-targets
      - echo ""
      - echo "Updating Boundary configuration..."
      - terraform apply -auto-approve
      - echo "‚úÖ Target discovery updated"

  status-full:
    desc: "Complete deployment status with all details"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üìä Complete Boundary Deployment Status -"
      - echo ""
      - echo "=== Boundary Cluster ==="
      - terraform output boundary_cluster_url 2>/dev/null || echo "‚ùå Boundary cluster not configured"
      - echo ""
      - echo "=== Infrastructure Discovery ==="
      - terraform output discovered_infrastructure 2>/dev/null || echo "‚ùå No infrastructure discovered"
      - echo ""
      - echo "=== Host Catalogs ==="
      - terraform output -json host_catalogs 2>/dev/null | jq -r 'to_entries[] | "\\(.key) - \\(.value)"' || echo "‚ùå No host catalogs configured"
      - echo ""
      - echo "=== Credential Stores ==="
      - terraform output -json credential_stores 2>/dev/null | jq -r 'to_entries[] | "\\(.key) - \\(.value)"' || echo "‚ùå No credential stores configured"
      - echo ""
      - echo "=== Active Targets ==="
      - terraform output -json boundary_targets 2>/dev/null | jq -r 'to_entries[] | "\\(.key) - \\(.value.id) [\\(.value.type) port \\(.value.port)]"' || echo "‚ùå No targets configured"
      - echo ""
      - echo "=== Quick Connection Commands ==="
      - terraform output connection_commands 2>/dev/null || echo "‚ùå Connection commands not available"

  cleanup-all:
    desc: "Remove all Boundary resources"
    dir: "{{.BOUNDARY_DIR}}"
    cmds:
      - echo "üóëÔ∏è  Cleaning up all Boundary resources..."
      - echo ""
      - echo "This will remove -"
      - echo "- All Boundary targets"
      - echo "- All host catalogs and host sets"
      - echo "- All credential stores and credentials"
      - echo "- All Boundary configuration"
      - echo ""
      - echo "‚ö†Ô∏è  This action cannot be undone!"
      - echo "Continue? (Ctrl+C to cancel, Enter to proceed)"
      - read confirm
      - terraform destroy -auto-approve
      - echo "‚úÖ All Boundary resources removed"

  default:
    desc: "Show help by default"
    cmds:
      - task: help